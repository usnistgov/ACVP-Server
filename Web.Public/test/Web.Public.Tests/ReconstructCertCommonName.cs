using System;
using System.Linq;
using System.Security.Cryptography.X509Certificates;
using NIST.CVP.Math;
using NUnit.Framework;

namespace Web.Public.Tests
{
	[TestFixture]
	public class ReconstructCertCommonName
	{

		[Test]
		public void ShouldGetCommonNameFromCert()
		{
			var expectedSubject = "E=russell.hammett@nist.gov, CN=Russ Hammett, OU=ACVP, O=NIST, L=Gaithersburg, S=Maryland, C=US";
			var certBytes = new BitString("308206473082052FA00302010202135800000025F747F2F514FB0159000000000025300D06092A864886F70D01010B0500305A31133011060A0992268993F22C6401191603676F7631143012060A0992268993F22C64011916046E69737431133011060A0992268993F22C6401191603646576311830160603550403130F4E4953542043565020446576204341301E170D3230303530383136333935335A170D3232303530383136343935335A308195310B30090603550406130255533111300F060355040813084D6172796C616E64311530130603550407130C476169746865727362757267310D300B060355040A13044E495354310D300B060355040B130441435650311530130603550403130C527573732048616D6D6574743127302506092A864886F70D010901161872757373656C6C2E68616D6D657474406E6973742E676F7630820122300D06092A864886F70D01010105000382010F003082010A0282010100ED244BDCB7CFEA6577799747EEE3122D0FE266B8D6EE181E2D4C7405351011289391D64AF1D29B2D7FE00EFEAB2A98DC937DBF432432569583E8852722AF0727B14DD85D79B00DC1EF43FDBA586EF1D4CF33A1968C63E8739C7859D9BA57DFB88EFA1126A2E109995068096225EC521656F0306496357C5137A12216F571B3FA321A7A9327FBC34DE811938B794D06DFAAB5A2B816A7CA41F562997CE8113D5C924A2C7371764CF7BB3E7ED02894F6E06E84526E4A3D8631EF7FD8A2928DD3C5E07DFE5564E3B66784767DCBEDC5A1F20D321A2D9C2D606E9FD48CED23B16690B68C29114BBFD39EB3FD2CFB98C25DE4F5E852C1F61AC6F9DDE11CB7631F4FE30203010001A38202C8308202C4301D0603551D0E04160414F8344D2A075C1F4670E63DC47B3052919C131AAC301F0603551D23041830168014F0E6568F112A4EE48D24480D86792931C76FDC743081D90603551D1F0481D13081CE3081CBA081C8A081C58681C26C6461703A2F2F2F434E3D4E49535425323043565025323044657625323043412C434E3D4143565044657643412C434E3D4344502C434E3D5075626C69632532304B657925323053657276696365732C434E3D53657276696365732C434E3D436F6E66696775726174696F6E2C44433D6465762C44433D6E6973742C44433D676F763F63657274696669636174655265766F636174696F6E4C6973743F626173653F6F626A656374436C6173733D63524C446973747269627574696F6E506F696E743081CB06082B060105050701010481BE3081BB3081B806082B060105050730028681AB6C6461703A2F2F2F434E3D4E49535425323043565025323044657625323043412C434E3D4149412C434E3D5075626C69632532304B657925323053657276696365732C434E3D53657276696365732C434E3D436F6E66696775726174696F6E2C44433D6465762C44433D6E6973742C44433D676F763F634143657274696669636174653F626173653F6F626A656374436C6173733D63657274696669636174696F6E417574686F72697479300C0603551D130101FF04023000300E0603551D0F0101FF0404030205A0303C06092B0601040182371507042F302D06252B060104018237150886E6F0609FAF2D9993398782D36081F9C93B810986C6CC0784DB8B0602016402010430160603551D250101FF040C300A06082B06010505070302301E06092B060104018237150A0101FF040E300C300A06082B06010505070302304406092A864886F70D01090F04373035300E06082A864886F70D030202020080300E06082A864886F70D030402020080300706052B0E030207300A06082A864886F70D0307300D06092A864886F70D01010B050003820101007A1D925289405094F22F07FB677DA948FD245C4B1A6E6E17FFA740ED339C31303F54A119019508AB0A43F8773306C28845A3995DBD9B1CE01A56E196A5766AAE7FD59894CEE54199DC9BB4FF98EE3D6E5FD39187A0A33FC94514F8A91F52E6571A6187F2F53FFB73B8E64EEB1C36E794C7E6BF412BD5A0642E0EE92BCA6816513A3DC8017DFF04945C1499A172BD825C606684FEEC35DC25542024C9A42E7D87E2B2457431EB37F0E1316861EA6C33008EDBEFFB02CD41B34A2A9DF4686BFC0151C68FE8A9CEAFBE519EEA3B19793749A32F08D8D381C9DEAFAC01A11616C7EE6FAD8A9D3A0F06FC0730C208F976DCF5743A405514CCDBD1B87057DA0285DD69").ToBytes();
		
			var cert = new X509Certificate2(certBytes);
			
			Assert.AreEqual(expectedSubject, cert.Subject);
		}
		
		public static byte[] StringToByteArray(string hex) {
			return Enumerable.Range(0, hex.Length)
				.Where(x => x % 2 == 0)
				.Select(x => Convert.ToByte(hex.Substring(x, 2), 16))
				.ToArray();
		}
	}
}